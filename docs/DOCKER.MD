# Documenta√ß√£o de Execu√ß√£o: Backend Docker

### üö® Pr√©-requisito Global (Executar na primeira vez)

Antes de rodar qualquer outro comando, √© necess√°rio verificar a exist√™ncia da rede externa compartilhada entre os projetos, permitindo a comunica√ß√£o entre Backend, Frontend e Banco de Dados.

```bash
# Para ambiente de Desenvolvimento
docker network inspect nextflow-development-network >/dev/null 2>&1 || docker network create nextflow-development-network 

# Para ambiente de Homologa√ß√£o
docker network inspect nextflow-staging-network >/dev/null 2>&1 || docker network create nextflow-staging-network 
```

> ‚ö†Ô∏è **Observa√ß√£o (Windows):** a mensagem de erro relacionada a `/dev/null` pode aparecer, mas a cria√ß√£o da rede ocorre normalmente.

---

## üèõ Motiva√ß√£o da Arquitetura

A arquitetura do backend segue o mesmo princ√≠pio adotado no frontend:
**a pr√≥pria aplica√ß√£o √© respons√°vel pelo seu build e deploy**, garantindo previsibilidade entre ambientes e evitando depend√™ncia de ferramentas externas complexas.

A estrutura baseia-se nos seguintes arquivos:

* **Dockerfile:** Respons√°vel por gerar a imagem do backend pronta para execu√ß√£o (produ√ß√£o/homologa√ß√£o).
* **Dockerfile.development:** Imagem voltada para desenvolvimento local, com hot reload e ferramentas adicionais.
* **docker-compose.staging.yml:** Orquestra√ß√£o do backend e depend√™ncias para ambientes de homologa√ß√£o/produ√ß√£o.
* **docker-compose.development.yml:** Orquestra√ß√£o para ambiente de desenvolvimento local.

---

## 1. Ambiente de Desenvolvimento (Local)

Este ambiente habilita:

* **Hot Reload** da aplica√ß√£o backend.
* Uso de **vari√°veis locais** via `.env`.
* Comunica√ß√£o direta com banco de dados via Docker Network.

**Pr√©-requisito:**
Certifique-se de possuir um arquivo `.env` na raiz do backend (copie do `.env.example`).

Para iniciar:

```bash
docker compose -f docker-compose.development.yml up -d --build
```

> **Acesso:**
> API dispon√≠vel na porta configurada no `.env` (ex: `http://localhost:8080`)

---

## 2. Ambiente de Homologa√ß√£o

O ambiente de homologa√ß√£o √© **id√™ntico ao de produ√ß√£o**, simulando o comportamento real de um pipeline de CI/CD.
As vari√°veis sens√≠veis s√£o injetadas **no momento da execu√ß√£o**, garantindo isolamento e seguran√ßa.

### Comando de subida (Windows)

```bash
docker network create nextflow-staging-network & set DB_TIMEZONE=America/Sao_Paulo & set POSTGRES_DB=nextflow_staging_db & set POSTGRES_USER=admin_staging & set POSTGRES_PASSWORD=senha_segura_staging_123 & set JWT_KEY=chave_jwt_muito_segura_para_staging_32_chars & set BACKEND_PORT=8082 & set POSTGRES_PORT=5434 & docker compose -f docker-compose.staging.yml up -d --build

```

### Vari√°veis utilizadas

| Vari√°vel            | Descri√ß√£o                   |
| ------------------- | --------------------------- |
| `DB_TIMEZONE`       | Timezone do banco de dados  |
| `POSTGRES_DB`       | Nome do banco               |
| `POSTGRES_USER`     | Usu√°rio do PostgreSQL       |
| `POSTGRES_PASSWORD` | Senha do banco              |
| `JWT_KEY`           | Chave de assinatura JWT     |
| `BACKEND_PORT`      | Porta exposta pela API      |
| `POSTGRES_PORT`     | Porta externa do PostgreSQL |

> **Acesso:**
> API dispon√≠vel em: [http://localhost:8081](http://localhost:8081)

---

## üîß Gerenciamento e Debug

### Visualizar Logs

√ötil para diagnosticar falhas de inicializa√ß√£o, migrations ou erros de API:

```bash
# Desenvolvimento
docker compose -f docker-compose.development.yml logs -f backend

# Homologa√ß√£o
docker compose -f docker-compose.staging.yml logs -f backend
```

---

### Acessar o Terminal do Container

Permite executar comandos internos, verificar arquivos ou testar conex√µes:

```bash
# Desenvolvimento
docker exec -it -e TERM=xterm nextflow-development-backend-1 sh

# Homologa√ß√£o
docker exec -it -e TERM=xterm nextflow-staging-backend-1 sh
```

---

### Parar o Ambiente

```bash
docker compose -f docker-compose.development.yml down
```

*(Nota: O nome do container pode variar de acordo com a pasta raiz do projeto. Caso falhe, utilize `docker ps` para identificar o nome correto.)*

---

## ‚úÖ Considera√ß√µes Importantes

* O backend e o frontend **devem estar na mesma network Docker** para comunica√ß√£o direta.
* Vari√°veis de ambiente **n√£o devem ser versionadas**.
* Ambientes de homologa√ß√£o e produ√ß√£o **devem sempre usar imagens buildadas**, nunca hot reload.
* Essa arquitetura √© totalmente compat√≠vel com pipelines de **Bitbucket Pipelines / GitHub Actions**.

